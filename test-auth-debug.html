<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Debug Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            background: #222;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        #output {
            white-space: pre-wrap;
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #444;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Situ8 Auth Debug Test</h1>
    
    <div class="test-section">
        <h2>1. Check Environment & Config</h2>
        <button onclick="checkEnvironment()">Check Environment</button>
        <button onclick="checkCognitoConfig()">Check Cognito Config</button>
        <button onclick="checkAmplifyInit()">Check Amplify Init</button>
    </div>

    <div class="test-section">
        <h2>2. Test User Authentication</h2>
        <div>
            <input type="email" id="email" placeholder="Email" value="yamen@example.com" style="width: 200px;">
            <input type="password" id="password" placeholder="Password" value="TempPassword123!" style="width: 200px;">
            <button onclick="testLogin()">Test Login</button>
        </div>
        <div style="margin-top: 10px;">
            <button onclick="testUserLogin('yamen@example.com')">Test Yamen (L3)</button>
            <button onclick="testUserLogin('river@example.com')">Test River (L5)</button>
            <button onclick="testUserLogin('celine@example.com')">Test Celine (L4)</button>
            <button onclick="testUserLogin('phil@example.com')">Test Phil (L1)</button>
        </div>
    </div>

    <div class="test-section">
        <h2>3. Check Auth Service</h2>
        <button onclick="checkAuthService()">Check Auth Service</button>
        <button onclick="checkCurrentUser()">Check Current User</button>
        <button onclick="testLogout()">Test Logout</button>
    </div>

    <div class="test-section">
        <h2>Output:</h2>
        <div id="output"></div>
    </div>

    <script type="module">
        window.log = function(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        };

        window.checkEnvironment = async function() {
            log('=== Checking Environment ===');
            
            // Check if we're in development
            log(`Mode: ${import.meta.env.MODE}`);
            log(`Dev: ${import.meta.env.DEV}`);
            log(`Base URL: ${import.meta.env.BASE_URL}`);
            
            // Check AWS-related env vars
            const envVars = [
                'VITE_USE_AWS_API',
                'VITE_AWS_REGION',
                'VITE_COGNITO_USER_POOL_ID',
                'VITE_COGNITO_CLIENT_ID',
                'VITE_API_BASE_URL',
                'REACT_APP_USE_AWS_API',
                'REACT_APP_AWS_REGION',
                'REACT_APP_COGNITO_USER_POOL_ID',
                'REACT_APP_COGNITO_CLIENT_ID'
            ];
            
            envVars.forEach(key => {
                const value = import.meta.env[key] || process.env?.[key];
                if (value) {
                    log(`✓ ${key}: ${value.substring(0, 20)}...`, 'success');
                } else {
                    log(`✗ ${key}: not set`, 'error');
                }
            });
        };

        window.checkCognitoConfig = async function() {
            log('=== Checking Cognito Config ===');
            try {
                const { getCognitoConfig } = await import('./config/cognito.ts');
                const config = getCognitoConfig();
                
                log(`Region: ${config.region}`, 'success');
                log(`User Pool ID: ${config.userPoolId}`, 'success');
                log(`Client ID: ${config.userPoolWebClientId}`, 'success');
                log(`Identity Pool: ${config.identityPoolId || 'not set'}`);
                log(`Domain: ${config.domain || 'not set'}`);
                log(`Redirect Sign In: ${config.redirectSignIn}`);
                log(`Redirect Sign Out: ${config.redirectSignOut}`);
                
                // Validate required fields
                if (!config.userPoolId || !config.userPoolWebClientId) {
                    log('ERROR: Missing required Cognito configuration!', 'error');
                } else {
                    log('✓ Cognito config looks valid', 'success');
                }
            } catch (error) {
                log(`Error loading Cognito config: ${error.message}`, 'error');
            }
        };

        window.checkAmplifyInit = async function() {
            log('=== Checking Amplify Initialization ===');
            try {
                const { initializeCognito } = await import('./services/cognito-client.ts');
                
                // Try to initialize
                initializeCognito();
                log('✓ Amplify initialized successfully', 'success');
                
                // Check if Amplify is configured
                const { Amplify } = await import('@aws-amplify/core');
                const config = Amplify.getConfig();
                log(`Amplify Config: ${JSON.stringify(config, null, 2)}`);
                
            } catch (error) {
                log(`Error initializing Amplify: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        };

        window.checkAuthService = async function() {
            log('=== Checking Auth Service ===');
            try {
                const { AuthService } = await import('./services/auth.service.ts');
                const authService = new AuthService();
                
                log(`Auth Service created: ${!!authService}`, 'success');
                log(`Is authenticated: ${authService.isAuthenticated()}`);
                log(`Current user: ${authService.getCurrentUser()?.email || 'none'}`);
                log(`Demo mode: ${authService.isInDemoMode()}`);
                
                // Check health
                const health = await authService.healthCheck();
                log(`Health check: ${health.status} - ${health.message}`, health.status === 'healthy' ? 'success' : 'error');
                
            } catch (error) {
                log(`Error with Auth Service: ${error.message}`, 'error');
            }
        };

        window.testLogin = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            log(`=== Testing Login: ${email} ===`);
            
            try {
                // Import auth service
                const { AuthService } = await import('./services/auth.service.ts');
                const authService = new AuthService();
                
                // Try to login
                const result = await authService.login({ email, password });
                
                if (result.success) {
                    log(`✓ Login successful!`, 'success');
                    log(`User: ${result.data.user.email}`);
                    log(`Role: ${result.data.user.role}`);
                    log(`Clearance: L${result.data.user.clearanceLevel}`);
                    log(`Tokens: ${!!result.data.tokens.accessToken}`);
                } else {
                    log(`✗ Login failed: ${result.error?.message || result.message}`, 'error');
                    if (result.error?.code) {
                        log(`Error code: ${result.error.code}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`Exception during login: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        };

        window.testUserLogin = function(email) {
            document.getElementById('email').value = email;
            document.getElementById('password').value = 'TempPassword123!';
            testLogin();
        };

        window.checkCurrentUser = async function() {
            log('=== Checking Current User ===');
            try {
                const cognitoOps = await import('./services/cognito-client.ts');
                const user = await cognitoOps.default.getCurrentUser();
                
                if (user) {
                    log(`✓ Current user: ${user.username}`, 'success');
                    log(`User ID: ${user.userId}`);
                    
                    // Get attributes
                    const attrs = await cognitoOps.default.getUserAttributes();
                    log(`Attributes: ${JSON.stringify(attrs, null, 2)}`);
                } else {
                    log('No user currently authenticated', 'info');
                }
                
            } catch (error) {
                log(`Error checking current user: ${error.message}`, 'error');
            }
        };

        window.testLogout = async function() {
            log('=== Testing Logout ===');
            try {
                const { AuthService } = await import('./services/auth.service.ts');
                const authService = new AuthService();
                
                const result = await authService.logout();
                if (result.success) {
                    log('✓ Logout successful', 'success');
                } else {
                    log(`✗ Logout failed: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log(`Error during logout: ${error.message}`, 'error');
            }
        };

        // Auto-run basic checks on load
        window.addEventListener('load', () => {
            log('=== Auth Debug Test Started ===', 'info');
            checkEnvironment();
        });
    </script>
</body>
</html>